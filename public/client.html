<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DigiComply ‚Äì Client Portal (Lite)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --secondary: #64748b;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --background: #f8fafc;
      --surface: #ffffff;
      --border: #e2e8f0;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
    
    * { box-sizing: border-box; }
    
    body { 
      font-family: 'Inter', system-ui, -apple-system, sans-serif; 
      margin: 0; 
      padding: 24px;
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.5;
    }
    
    h1 { 
      font-size: 2rem; 
      font-weight: 700; 
      margin: 0 0 8px 0; 
      color: var(--text-primary);
    }
    
    .header-subtitle {
      color: var(--text-secondary);
      font-size: 1rem;
      margin-bottom: 32px;
    }
    
    .controls {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-sm);
    }
    
    .row { 
      display: flex; 
      gap: 16px; 
      flex-wrap: wrap; 
      align-items: flex-end; 
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      min-width: 140px;
    }
    
    label {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    
    input, select, button { 
      padding: 10px 12px; 
      border-radius: 8px; 
      border: 1px solid var(--border); 
      font-size: 14px;
      background: var(--surface);
      transition: all 0.2s ease;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
    }
    
    button { 
      background: var(--primary); 
      color: white; 
      border: none; 
      cursor: pointer;
      font-weight: 500;
      height: fit-content;
    }
    
    button:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }
    
    .services-grid {
      display: grid;
      gap: 20px;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    }
    
    .service-card { 
      background: var(--surface);
      border: 1px solid var(--border); 
      border-radius: 12px; 
      padding: 24px; 
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
    }
    
    .service-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    
    .service-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    
    .service-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }
    
    .service-period {
      font-size: 13px;
      color: var(--text-secondary);
      margin: 4px 0 0 0;
    }
    
    .service-due {
      font-size: 12px;
      color: var(--warning);
      font-weight: 500;
    }
    
    .service-meta {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      font-size: 13px;
    }
    
    .status { 
      padding: 4px 10px; 
      border-radius: 20px; 
      font-size: 12px; 
      font-weight: 500;
    }
    
    .status.created { background: #f1f5f9; color: var(--secondary); }
    .status.in-progress { background: #eff6ff; color: var(--primary); }
    .status.waiting-on-client { background: #fefce8; color: var(--warning); }
    .status.completed { background: #f0fdf4; color: var(--success); }
    
    .doc-summary {
      color: var(--text-muted);
      font-size: 12px;
    }
    
    .document-section {
      border-top: 1px solid var(--border);
      padding-top: 16px;
      margin-top: 16px;
    }
    
    .upload-area {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    
    .upload-area select {
      flex: 1;
      min-width: 140px;
    }
    
    .upload-area input[type="file"] {
      flex: 2;
      min-width: 180px;
    }
    
    .upload-area button {
      background: var(--success);
      padding: 8px 16px;
      font-size: 13px;
    }
    
    .document-list {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .document-item {
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      font-size: 13px;
    }
    
    .doc-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    
    .doc-name {
      font-weight: 500;
      color: var(--text-primary);
    }
    
    .doc-version {
      background: var(--border);
      color: var(--text-secondary);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
    }
    
    .doc-details {
      color: var(--text-muted);
      font-size: 12px;
      margin-bottom: 4px;
    }
    
    .doc-status {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .doc-status-approved { background: #d1fae5; color: #16a34a; }
    .doc-status-pending { background: #fef3c7; color: #d97706; }
    .doc-status-rejected { background: #fee2e2; color: #dc2626; }
    
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-muted);
    }
    
    .empty-state h3 {
      margin: 0 0 8px 0;
      color: var(--text-secondary);
    }
    
    @media (max-width: 768px) {
      body { padding: 16px; }
      .services-grid { grid-template-columns: 1fr; }
      .row { flex-direction: column; align-items: stretch; }
      .upload-area { flex-direction: column; }
      .upload-area select, .upload-area input { min-width: auto; }
      h1 { font-size: 1.75rem; }
    }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <h1>Your Compliance Dashboard</h1>
  <p class="header-subtitle">Track service progress, manage documents, and stay compliant with all regulatory requirements.</p>

  <div class="controls">
    <div class="row">
      <div class="form-group">
        <label>Business Entity</label>
        <input id="entity" type="number" value="1" />
      </div>
      <button onclick="loadSO()">Load Services</button>
    </div>
  </div>

  <div id="list"></div>

<script>
const api = (p, opt={}) => fetch(p, { headers: {'Accept':'application/json'}, ...opt }).then(r=>r.json());

async function loadSO(){
  const entity = +document.getElementById('entity').value;
  const rows = await api(`/client/entities/${entity}/service-orders`);
  if (!Array.isArray(rows) || rows.length===0){
    document.getElementById('list').innerHTML = `
      <div class="empty-state">
        <h3>No Services Yet</h3>
        <p>Your compliance services will appear here once configured by your service provider.</p>
      </div>`;
    return;
  }
  
  const cards = rows.map(r => `
    <div class="service-card">
      <div class="service-header">
        <div>
          <h3 class="service-title">${r.serviceType}</h3>
          <p class="service-period">${r.periodLabel || 'One-time service'}</p>
        </div>
        <div class="service-due">
          ${r.dueDate ? `Due: ${new Date(r.dueDate).toLocaleDateString()}` : ''}
        </div>
      </div>
      
      <div class="service-meta">
        <span class="status ${r.status.toLowerCase().replace(/ /g, '-')}">${r.status}</span>
        <span class="doc-summary">
          üìÑ ${r.docsApproved} approved ‚Ä¢ ${r.docsPending} pending ‚Ä¢ ${r.docsRejected} rejected
        </span>
      </div>
      
      <div class="document-section">
        <div id="docs_${r.id}" class="document-list">Loading documents...</div>
        <div class="upload-area">
          <select id="dt_${r.id}" placeholder="Select document type"></select>
          <input type="file" id="file_${r.id}" />
          <button onclick="upload(${r.id})">Upload Document</button>
        </div>
      </div>
    </div>
  `).join('');
  
  document.getElementById('list').innerHTML = `<div class="services-grid">${cards}</div>`;
  
  // load required doctypes + current docs for each SO
  rows.forEach(async so => {
    const reqd = await api(`/client/service-orders/${so.id}/required-docs`);
    const sel = document.getElementById(`dt_${so.id}`);
    sel.innerHTML = reqd.map(d => `<option value="${d.doctype}">${d.label}</option>`).join('');
    await refreshDocs(so.id);
  });
}

async function refreshDocs(soId){
  const docs = await api(`/client/service-orders/${soId}/documents`);
  const c = document.getElementById(`docs_${soId}`);
  if (!docs.length) { 
    c.innerHTML = '<div class="empty-state" style="padding: 20px;"><p>No documents uploaded yet.</p></div>'; 
    return; 
  }
  c.innerHTML = docs.map(d => `
    <div class="document-item">
      <div class="doc-header">
        <span class="doc-name">${d.doctype}</span>
        <span class="doc-version">v${d.version}</span>
      </div>
      <div class="doc-details">${d.filename} ‚Ä¢ ${(d.sizeBytes||0)/1024|0} KB ‚Ä¢ ${d.uploader}</div>
      <div class="doc-details">${new Date(d.createdAt).toLocaleString()}</div>
      <div>
        <span class="doc-status doc-status-${d.status.replace('_', '-')}">${d.status}</span>
        ${d.rejectionReason ? `<span style="color: var(--danger); font-size: 12px; margin-left: 8px;">${d.rejectionReason}</span>` : ''}
      </div>
    </div>
  `).join('');
}

async function upload(soId){
  const fd = new FormData();
  const f = document.getElementById(`file_${soId}`).files[0];
  const dt = document.getElementById(`dt_${soId}`).value;
  if (!f) { alert('Please choose a file'); return; }
  const url = `/client/service-orders/${soId}/upload?doctype=${encodeURIComponent(dt)}`;
  fd.append('file', f);
  const res = await fetch(url, { method:'POST', body: fd });
  const j = await res.json();
  if (j.ok) { 
    alert('‚úÖ Uploaded successfully!'); 
    await refreshDocs(soId); 
    // Clear file input
    document.getElementById(`file_${soId}`).value = '';
  } else { 
    alert('‚ùå ' + (j.error || 'Upload failed')); 
  }
}

// Load data on page load
window.addEventListener('load', loadSO);
</script>
</body>
</html>



    <!-- SERVICE CARDS -->
    <div class="cards" id="services-grid">
      <!-- Dynamic content will be loaded here -->
    </div>
  </div>

  <!-- DOCUMENT UPLOAD MODAL -->
  <div id="upload-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3>Upload Document</h3>
      <div style="margin: 16px 0;">
        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: #374151;">Document Type:</label>
        <input id="upload-doctype" readonly style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px;" />
      </div>
      <div style="margin: 16px 0;">
        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: #374151;">Select File:</label>
        <input type="file" id="upload-file" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px;" />
      </div>
      <div style="text-align: right; margin-top: 20px;">
        <button onclick="uploadDocument()" style="background: #3b82f6; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Upload</button>
      </div>
    </div>
  </div>

<script>
const api = (p, opt={}) => fetch(p, { headers:{'Content-Type':'application/json'}, ...opt }).then(r=>r.json());

let currentUpload = null;

async function loadServices() {
  try {
    // For demo purposes, we'll use entity ID 1
    const entityId = 1;
    const orders = await api('/api/service-orders');
    
    // Filter orders for this entity (in real app, this would be user-specific)
    const myOrders = orders.filter(order => order.entityId === entityId || true); // For demo, show all
    
    updateStats(myOrders);
    renderServices(myOrders);
    
  } catch (error) {
    console.error('Error loading services:', error);
    document.getElementById('services-grid').innerHTML = 
      '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6b7280;">Unable to load services. Please try again.</div>';
  }
}

function updateStats(orders) {
  const active = orders.filter(o => o.status !== 'Completed').length;
  const pending = orders.filter(o => o.status === 'Waiting on Client').length;
  const upcoming = orders.filter(o => {
    const dueDate = new Date(o.dueDate);
    const now = new Date();
    const diffDays = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
    return diffDays <= 7 && diffDays > 0 && o.status !== 'Completed';
  }).length;
  const completed = orders.filter(o => o.status === 'Completed').length;
  
  document.getElementById('stat-active').textContent = active;
  document.getElementById('stat-pending').textContent = pending;
  document.getElementById('stat-upcoming').textContent = upcoming;
  document.getElementById('stat-completed').textContent = completed;
}

function renderServices(orders) {
  const grid = document.getElementById('services-grid');
  
  if (orders.length === 0) {
    grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6b7280;">No services found.</div>';
    return;
  }
  
  const statusFilter = document.getElementById('filter-status').value;
  const serviceFilter = document.getElementById('filter-service').value;
  
  const filteredOrders = orders.filter(order => {
    if (statusFilter && order.status !== statusFilter) return false;
    if (serviceFilter && order.serviceType !== serviceFilter) return false;
    return true;
  });
  
  grid.innerHTML = filteredOrders.map(order => createServiceCard(order)).join('');
}

function createServiceCard(order) {
  const dueDate = new Date(order.dueDate);
  const now = new Date();
  const diffDays = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
  const isOverdue = diffDays < 0 && order.status !== 'Completed';
  const isUpcoming = diffDays <= 7 && diffDays > 0;
  
  const statusClass = getStatusClass(order.status);
  const progress = getProgressPercentage(order.status);
  
  return `
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">${formatServiceName(order.serviceType)}</h3>
        <span class="status-badge ${statusClass}">${order.status || 'Created'}</span>
      </div>
      
      <div class="card-meta">
        Period: ${order.periodLabel || 'N/A'} | Priority: ${order.priority || 'Medium'}
      </div>
      
      <div class="progress-bar">
        <div class="progress-fill" style="width: ${progress}%"></div>
      </div>
      
      <div class="card-due ${isOverdue ? 'style="color: #ef4444; font-weight: 600;"' : isUpcoming ? 'style="color: #f59e0b; font-weight: 600;"' : ''}">
        Due: ${formatDate(order.dueDate)} ${diffDays < 0 ? `(${Math.abs(diffDays)} days overdue)` : diffDays <= 7 ? `(${diffDays} days left)` : ''}
      </div>
      
      ${getDocumentsSection(order)}
      
      <div class="card-actions">
        ${getActionButtons(order)}
      </div>
    </div>
  `;
}

function getStatusClass(status) {
  const classes = {
    'Created': 'status-created',
    'In Progress': 'status-progress',
    'Waiting on Client': 'status-waiting',
    'Completed': 'status-completed'
  };
  return classes[status] || 'status-created';
}

function getProgressPercentage(status) {
  const progress = {
    'Created': 10,
    'In Progress': 60,
    'Waiting on Client': 80,
    'QA Review': 90,
    'Completed': 100
  };
  return progress[status] || 0;
}

function formatServiceName(serviceType) {
  const names = {
    'gst_returns': 'GST Returns Filing',
    'tds_quarterly': 'TDS Quarterly Returns',
    'incorporation': 'Company Incorporation',
    'annual_filings_roc': 'Annual ROC Filings',
    'itr_annual': 'Income Tax Returns',
    'accounting_monthly': 'Monthly Accounting'
  };
  return names[serviceType] || serviceType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function getDocumentsSection(order) {
  // Mock document requirements based on service type
  const docs = getMockDocuments(order.serviceType, order.status);
  
  if (docs.length === 0) return '';
  
  return `
    <div class="docs-section">
      <h4 style="margin: 0 0 8px 0; font-size: 13px; color: #374151;">Required Documents:</h4>
      ${docs.map(doc => `
        <div class="doc-item">
          <span class="doc-name">${doc.name}</span>
          <div>
            <span class="doc-status ${doc.statusClass}">${doc.status}</span>
            ${doc.canUpload ? `<button onclick="openUploadModal('${doc.type}', ${order.id})" style="margin-left: 8px; padding: 2px 6px; font-size: 10px; border: none; background: #f3f4f6; border-radius: 3px; cursor: pointer;">Upload</button>` : ''}
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

function getMockDocuments(serviceType, status) {
  const docTypes = {
    'gst_returns': [
      { type: 'sales_register', name: 'Sales Register (CSV)', required: true },
      { type: 'purchase_register', name: 'Purchase Register (CSV)', required: true },
      { type: 'bank_statements', name: 'Bank Statements', required: false }
    ],
    'tds_quarterly': [
      { type: 'payroll_register', name: 'Payroll Register', required: true },
      { type: 'vendor_payments', name: 'Vendor Payment Details', required: true }
    ],
    'incorporation': [
      { type: 'director_pan', name: 'Director PAN Cards', required: true },
      { type: 'address_proof', name: 'Address Proof', required: true }
    ]
  };
  
  const docs = docTypes[serviceType] || [];
  
  return docs.map(doc => {
    let docStatus = 'Pending';
    let statusClass = 'doc-pending';
    let canUpload = true;
    
    // Mock logic for document status based on service status
    if (status === 'Completed') {
      docStatus = 'Approved';
      statusClass = 'doc-approved';
      canUpload = false;
    } else if (status === 'In Progress' && Math.random() > 0.5) {
      docStatus = 'Uploaded';
      statusClass = 'doc-uploaded';
      canUpload = false;
    }
    
    return {
      ...doc,
      status: docStatus,
      statusClass,
      canUpload
    };
  });
}

function getActionButtons(order) {
  const buttons = [];
  
  if (order.status === 'Waiting on Client') {
    buttons.push('<a href="#" class="btn btn-primary" onclick="viewDetails(' + order.id + ')">Action Required</a>');
  }
  
  if (order.status === 'Completed') {
    buttons.push('<a href="#" class="btn btn-outline" onclick="downloadDeliverables(' + order.id + ')">Download Files</a>');
  } else {
    buttons.push('<a href="#" class="btn btn-outline" onclick="viewDetails(' + order.id + ')">View Details</a>');
  }
  
  return buttons.join('');
}

function openUploadModal(docType, orderId) {
  currentUpload = { docType, orderId };
  document.getElementById('upload-doctype').value = docType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
  document.getElementById('upload-modal').style.display = 'block';
}

function closeModal() {
  document.getElementById('upload-modal').style.display = 'none';
  document.getElementById('upload-file').value = '';
  currentUpload = null;
}

async function uploadDocument() {
  if (!currentUpload) return;
  
  const file = document.getElementById('upload-file').files[0];
  if (!file) {
    alert('Please select a file to upload');
    return;
  }
  
  // Mock upload (in real app, this would upload to actual storage)
  try {
    // Simulate upload delay
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    alert(`Document "${file.name}" uploaded successfully!`);
    closeModal();
    loadServices(); // Refresh the view
    
  } catch (error) {
    console.error('Upload error:', error);
    alert('Upload failed. Please try again.');
  }
}

function viewDetails(orderId) {
  alert(`Viewing details for order ${orderId}. In the full app, this would show detailed workflow status, communication history, and next steps.`);
}

function downloadDeliverables(orderId) {
  alert(`Downloading deliverables for order ${orderId}. In the full app, this would provide download links for completed documents.`);
}

function formatDate(dateStr) {
  if (!dateStr) return 'N/A';
  return new Date(dateStr).toLocaleDateString('en-IN', {
    day: 'numeric',
    month: 'short',
    year: 'numeric'
  });
}

// Close modal when clicking outside
window.onclick = function(event) {
  const modal = document.getElementById('upload-modal');
  if (event.target === modal) {
    closeModal();
  }
}

// Auto-refresh every 60 seconds
setInterval(loadServices, 60000);

// Load initial data
window.addEventListener('load', loadServices);
</script>
</body>
</html>