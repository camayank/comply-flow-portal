<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DigiComply – Client Portal (Lite)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    h1 { margin-bottom: 8px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
    input, select, button { padding:8px 10px; border-radius:8px; border:1px solid #e5e7eb; font-size:14px; }
    button { background:#111827; color:#fff; border:none; cursor:pointer; }
    .card { border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin:12px 0; box-shadow:0 1px 2px rgba(0,0,0,0.04); }
    table { border-collapse: collapse; width:100%; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; font-size:14px; vertical-align:top; }
    .status { padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:12px; }
    .muted { color:#6b7280; font-size:12px; }
    .pill { padding:2px 8px; border-radius:999px; background:#f1f5f9; font-size:12px; }
    details { margin-top:8px; }
    .doc-status-approved { background:#d1fae5; color:#16a34a; }
    .doc-status-pending { background:#fef3c7; color:#d97706; }
    .doc-status-rejected { background:#fee2e2; color:#dc2626; }
  </style>
</head>
<body>
  <h1>Your Compliance Services</h1>
  <p class="muted">Pick your business (entity), then manage documents and track status.</p>

  <div class="row">
    <div><label>Entity ID<br/><input id="entity" type="number" value="1" /></label></div>
    <button onclick="loadSO()">Load Services</button>
  </div>

  <div id="list"></div>

<script>
const api = (p, opt={}) => fetch(p, { headers: {'Accept':'application/json'}, ...opt }).then(r=>r.json());

async function loadSO(){
  const entity = +document.getElementById('entity').value;
  const rows = await api(`/client/entities/${entity}/service-orders`);
  if (!Array.isArray(rows) || rows.length===0){
    document.getElementById('list').innerHTML = '<p class="muted">No services yet.</p>';
    return;
  }
  const html = ['<table><tr><th>Service</th><th>Period</th><th>Due</th><th>Status</th><th>Docs</th></tr>'];
  html.push(...rows.map(r => `
    <tr>
      <td>${r.serviceType}</td>
      <td>${r.periodLabel || '-'}</td>
      <td>${r.dueDate || '-'}</td>
      <td><span class="status">${r.status}</span><br/><span class="muted">Approved:${r.docsApproved} • Pending:${r.docsPending} • Rejected:${r.docsRejected}</span></td>
      <td>
        <details>
          <summary>Upload / View</summary>
          <div id="docs_${r.id}" class="muted">Loading...</div>
          <div style="margin-top:8px;">
            <label>Doctype&nbsp;
              <select id="dt_${r.id}"></select>
            </label>
            <input type="file" id="file_${r.id}" />
            <button onclick="upload(${r.id})">Upload</button>
          </div>
        </details>
      </td>
    </tr>
  `));
  html.push('</table>');
  document.getElementById('list').innerHTML = html.join('');
  // load required doctypes + current docs for each SO
  rows.forEach(async so => {
    const reqd = await api(`/client/service-orders/${so.id}/required-docs`);
    const sel = document.getElementById(`dt_${so.id}`);
    sel.innerHTML = reqd.map(d => `<option value="${d.doctype}">${d.label}</option>`).join('');
    await refreshDocs(so.id);
  });
}

async function refreshDocs(soId){
  const docs = await api(`/client/service-orders/${soId}/documents`);
  const c = document.getElementById(`docs_${soId}`);
  if (!docs.length) { c.innerHTML = '<span class="muted">No documents uploaded yet.</span>'; return; }
  c.innerHTML = docs.map(d => `
    <div class="card">
      <div><b>${d.doctype}</b> <span class="pill">v${d.version}</span></div>
      <div>${d.filename} • ${(d.sizeBytes||0)/1024|0} KB • <i>${d.uploader}</i></div>
      <div>Status: <span class="pill doc-status-${d.status.replace('_', '-')}">${d.status}</span> ${d.rejectionReason ? ' – ' + d.rejectionReason : ''}</div>
      <div class="muted">${new Date(d.createdAt).toLocaleString()}</div>
    </div>
  `).join('');
}

async function upload(soId){
  const fd = new FormData();
  const f = document.getElementById(`file_${soId}`).files[0];
  const dt = document.getElementById(`dt_${soId}`).value;
  if (!f) { alert('Please choose a file'); return; }
  const url = `/client/service-orders/${soId}/upload?doctype=${encodeURIComponent(dt)}`;
  fd.append('file', f);
  const res = await fetch(url, { method:'POST', body: fd });
  const j = await res.json();
  if (j.ok) { 
    alert('✅ Uploaded successfully!'); 
    await refreshDocs(soId); 
    // Clear file input
    document.getElementById(`file_${soId}`).value = '';
  } else { 
    alert('❌ ' + (j.error || 'Upload failed')); 
  }
}

// Load data on page load
window.addEventListener('load', loadSO);
</script>
</body>
</html>

    <!-- DASHBOARD STATS -->
    <div class="stats">
      <div class="stat">
        <div class="stat-number" id="stat-active">0</div>
        <div class="stat-label">Active Services</div>
      </div>
      <div class="stat">
        <div class="stat-number" id="stat-pending">0</div>
        <div class="stat-label">Pending Actions</div>
      </div>
      <div class="stat">
        <div class="stat-number" id="stat-upcoming">0</div>
        <div class="stat-label">Upcoming Due</div>
      </div>
      <div class="stat">
        <div class="stat-number" id="stat-completed">0</div>
        <div class="stat-label">Completed</div>
      </div>
    </div>

    <!-- FILTERS -->
    <div class="filters">
      <select id="filter-status">
        <option value="">All Statuses</option>
        <option value="Created">Created</option>
        <option value="In Progress">In Progress</option>
        <option value="Waiting on Client">Waiting on Client</option>
        <option value="Completed">Completed</option>
      </select>
      <select id="filter-service">
        <option value="">All Services</option>
        <option value="gst_returns">GST Returns</option>
        <option value="tds_quarterly">TDS Quarterly</option>
        <option value="incorporation">Incorporation</option>
        <option value="annual_filings_roc">Annual Filings</option>
      </select>
      <button onclick="loadServices()">Refresh</button>
    </div>

    <!-- SERVICE CARDS -->
    <div class="cards" id="services-grid">
      <!-- Dynamic content will be loaded here -->
    </div>
  </div>

  <!-- DOCUMENT UPLOAD MODAL -->
  <div id="upload-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3>Upload Document</h3>
      <div style="margin: 16px 0;">
        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: #374151;">Document Type:</label>
        <input id="upload-doctype" readonly style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px;" />
      </div>
      <div style="margin: 16px 0;">
        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: #374151;">Select File:</label>
        <input type="file" id="upload-file" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px;" />
      </div>
      <div style="text-align: right; margin-top: 20px;">
        <button onclick="uploadDocument()" style="background: #3b82f6; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Upload</button>
      </div>
    </div>
  </div>

<script>
const api = (p, opt={}) => fetch(p, { headers:{'Content-Type':'application/json'}, ...opt }).then(r=>r.json());

let currentUpload = null;

async function loadServices() {
  try {
    // For demo purposes, we'll use entity ID 1
    const entityId = 1;
    const orders = await api('/api/service-orders');
    
    // Filter orders for this entity (in real app, this would be user-specific)
    const myOrders = orders.filter(order => order.entityId === entityId || true); // For demo, show all
    
    updateStats(myOrders);
    renderServices(myOrders);
    
  } catch (error) {
    console.error('Error loading services:', error);
    document.getElementById('services-grid').innerHTML = 
      '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6b7280;">Unable to load services. Please try again.</div>';
  }
}

function updateStats(orders) {
  const active = orders.filter(o => o.status !== 'Completed').length;
  const pending = orders.filter(o => o.status === 'Waiting on Client').length;
  const upcoming = orders.filter(o => {
    const dueDate = new Date(o.dueDate);
    const now = new Date();
    const diffDays = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
    return diffDays <= 7 && diffDays > 0 && o.status !== 'Completed';
  }).length;
  const completed = orders.filter(o => o.status === 'Completed').length;
  
  document.getElementById('stat-active').textContent = active;
  document.getElementById('stat-pending').textContent = pending;
  document.getElementById('stat-upcoming').textContent = upcoming;
  document.getElementById('stat-completed').textContent = completed;
}

function renderServices(orders) {
  const grid = document.getElementById('services-grid');
  
  if (orders.length === 0) {
    grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6b7280;">No services found.</div>';
    return;
  }
  
  const statusFilter = document.getElementById('filter-status').value;
  const serviceFilter = document.getElementById('filter-service').value;
  
  const filteredOrders = orders.filter(order => {
    if (statusFilter && order.status !== statusFilter) return false;
    if (serviceFilter && order.serviceType !== serviceFilter) return false;
    return true;
  });
  
  grid.innerHTML = filteredOrders.map(order => createServiceCard(order)).join('');
}

function createServiceCard(order) {
  const dueDate = new Date(order.dueDate);
  const now = new Date();
  const diffDays = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
  const isOverdue = diffDays < 0 && order.status !== 'Completed';
  const isUpcoming = diffDays <= 7 && diffDays > 0;
  
  const statusClass = getStatusClass(order.status);
  const progress = getProgressPercentage(order.status);
  
  return `
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">${formatServiceName(order.serviceType)}</h3>
        <span class="status-badge ${statusClass}">${order.status || 'Created'}</span>
      </div>
      
      <div class="card-meta">
        Period: ${order.periodLabel || 'N/A'} | Priority: ${order.priority || 'Medium'}
      </div>
      
      <div class="progress-bar">
        <div class="progress-fill" style="width: ${progress}%"></div>
      </div>
      
      <div class="card-due ${isOverdue ? 'style="color: #ef4444; font-weight: 600;"' : isUpcoming ? 'style="color: #f59e0b; font-weight: 600;"' : ''}">
        Due: ${formatDate(order.dueDate)} ${diffDays < 0 ? `(${Math.abs(diffDays)} days overdue)` : diffDays <= 7 ? `(${diffDays} days left)` : ''}
      </div>
      
      ${getDocumentsSection(order)}
      
      <div class="card-actions">
        ${getActionButtons(order)}
      </div>
    </div>
  `;
}

function getStatusClass(status) {
  const classes = {
    'Created': 'status-created',
    'In Progress': 'status-progress',
    'Waiting on Client': 'status-waiting',
    'Completed': 'status-completed'
  };
  return classes[status] || 'status-created';
}

function getProgressPercentage(status) {
  const progress = {
    'Created': 10,
    'In Progress': 60,
    'Waiting on Client': 80,
    'QA Review': 90,
    'Completed': 100
  };
  return progress[status] || 0;
}

function formatServiceName(serviceType) {
  const names = {
    'gst_returns': 'GST Returns Filing',
    'tds_quarterly': 'TDS Quarterly Returns',
    'incorporation': 'Company Incorporation',
    'annual_filings_roc': 'Annual ROC Filings',
    'itr_annual': 'Income Tax Returns',
    'accounting_monthly': 'Monthly Accounting'
  };
  return names[serviceType] || serviceType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function getDocumentsSection(order) {
  // Mock document requirements based on service type
  const docs = getMockDocuments(order.serviceType, order.status);
  
  if (docs.length === 0) return '';
  
  return `
    <div class="docs-section">
      <h4 style="margin: 0 0 8px 0; font-size: 13px; color: #374151;">Required Documents:</h4>
      ${docs.map(doc => `
        <div class="doc-item">
          <span class="doc-name">${doc.name}</span>
          <div>
            <span class="doc-status ${doc.statusClass}">${doc.status}</span>
            ${doc.canUpload ? `<button onclick="openUploadModal('${doc.type}', ${order.id})" style="margin-left: 8px; padding: 2px 6px; font-size: 10px; border: none; background: #f3f4f6; border-radius: 3px; cursor: pointer;">Upload</button>` : ''}
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

function getMockDocuments(serviceType, status) {
  const docTypes = {
    'gst_returns': [
      { type: 'sales_register', name: 'Sales Register (CSV)', required: true },
      { type: 'purchase_register', name: 'Purchase Register (CSV)', required: true },
      { type: 'bank_statements', name: 'Bank Statements', required: false }
    ],
    'tds_quarterly': [
      { type: 'payroll_register', name: 'Payroll Register', required: true },
      { type: 'vendor_payments', name: 'Vendor Payment Details', required: true }
    ],
    'incorporation': [
      { type: 'director_pan', name: 'Director PAN Cards', required: true },
      { type: 'address_proof', name: 'Address Proof', required: true }
    ]
  };
  
  const docs = docTypes[serviceType] || [];
  
  return docs.map(doc => {
    let docStatus = 'Pending';
    let statusClass = 'doc-pending';
    let canUpload = true;
    
    // Mock logic for document status based on service status
    if (status === 'Completed') {
      docStatus = 'Approved';
      statusClass = 'doc-approved';
      canUpload = false;
    } else if (status === 'In Progress' && Math.random() > 0.5) {
      docStatus = 'Uploaded';
      statusClass = 'doc-uploaded';
      canUpload = false;
    }
    
    return {
      ...doc,
      status: docStatus,
      statusClass,
      canUpload
    };
  });
}

function getActionButtons(order) {
  const buttons = [];
  
  if (order.status === 'Waiting on Client') {
    buttons.push('<a href="#" class="btn btn-primary" onclick="viewDetails(' + order.id + ')">Action Required</a>');
  }
  
  if (order.status === 'Completed') {
    buttons.push('<a href="#" class="btn btn-outline" onclick="downloadDeliverables(' + order.id + ')">Download Files</a>');
  } else {
    buttons.push('<a href="#" class="btn btn-outline" onclick="viewDetails(' + order.id + ')">View Details</a>');
  }
  
  return buttons.join('');
}

function openUploadModal(docType, orderId) {
  currentUpload = { docType, orderId };
  document.getElementById('upload-doctype').value = docType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
  document.getElementById('upload-modal').style.display = 'block';
}

function closeModal() {
  document.getElementById('upload-modal').style.display = 'none';
  document.getElementById('upload-file').value = '';
  currentUpload = null;
}

async function uploadDocument() {
  if (!currentUpload) return;
  
  const file = document.getElementById('upload-file').files[0];
  if (!file) {
    alert('Please select a file to upload');
    return;
  }
  
  // Mock upload (in real app, this would upload to actual storage)
  try {
    // Simulate upload delay
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    alert(`Document "${file.name}" uploaded successfully!`);
    closeModal();
    loadServices(); // Refresh the view
    
  } catch (error) {
    console.error('Upload error:', error);
    alert('Upload failed. Please try again.');
  }
}

function viewDetails(orderId) {
  alert(`Viewing details for order ${orderId}. In the full app, this would show detailed workflow status, communication history, and next steps.`);
}

function downloadDeliverables(orderId) {
  alert(`Downloading deliverables for order ${orderId}. In the full app, this would provide download links for completed documents.`);
}

function formatDate(dateStr) {
  if (!dateStr) return 'N/A';
  return new Date(dateStr).toLocaleDateString('en-IN', {
    day: 'numeric',
    month: 'short',
    year: 'numeric'
  });
}

// Close modal when clicking outside
window.onclick = function(event) {
  const modal = document.getElementById('upload-modal');
  if (event.target === modal) {
    closeModal();
  }
}

// Auto-refresh every 60 seconds
setInterval(loadServices, 60000);

// Load initial data
window.addEventListener('load', loadServices);
</script>
</body>
</html>